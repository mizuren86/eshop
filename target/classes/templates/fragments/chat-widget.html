<div th:fragment="chatWidget">
    <style>
        .chat-icon {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: #28a745;
            color: white;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }

        .chat-container {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 450px;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 9999;
            border: 1px solid #28a745;
        }

        .chat-header {
            background: #28a745;
            color: white;
            padding: 15px;
            text-align: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            font-size: 18px;
            position: relative;
        }

        .mode-indicator {
            padding: 8px 10px;
            background: #f8f9fa;
            text-align: center;
            font-size: 14px;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        .human-active {
            background: #2196F3;
            color: white;
        }

        .quick-actions-wrapper {
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
            background: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scroll-behavior: smooth;
            white-space: nowrap;
            flex-grow: 1;
            padding-bottom: 5px;
        }

        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .quick-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            flex-shrink: 0;
        }

        .quick-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .human-btn {
            background: #2196F3;
        }

        .human-btn:hover {
            background: #0d8bf2;
        }

        .scroll-btn {
            background: #ddd;
            border: none;
            padding: 8px 12px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .scroll-btn:hover {
            background: #bbb;
        }

        .chat-box {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .message {
            padding: 12px;
            border-radius: 10px;
            margin: 5px 0;
            max-width: 85%;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .user-message {
            background: rgb(192, 192, 192);
            color: white;
            align-self: flex-end;
        }

        .bot-message {
            background: #e6f7e1;
            color: black;
            align-self: flex-start;
        }

        .human-message {
            background: #e3f2fd;
            color: black;
            align-self: flex-start;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            background: #f8f9fa;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .chat-input button {
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            min-width: 30px !important;
            flex-shrink: 0;
        }

        .user-avatar {
            background-color: #28a745;
        }

        .bot-avatar {
            background-color: #218838;
        }

        .human-avatar {
            background-color: #2196F3;
        }

        .timestamp {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .btn-close {
            position: absolute;
            right: 15px;
            top: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 50px;
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .connected {
            background-color: #28a745;
            animation: pulse 1.5s infinite;
        }
        
        .disconnected {
            background-color: #dc3545;
        }
        
        .connecting {
            background-color: #ffc107;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>

    <!-- å¼•å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- å®¢æœåœ–æ¨™ -->
    <div class="chat-icon" onclick="toggleChatWindow()">ğŸ’¬</div>

    <!-- èŠå¤©çª—å£ -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <strong>å®¢æœå°è©±</strong>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">æ™ºèƒ½å®¢æœ</span>
            </div>
            <button class="btn-close" onclick="toggleChatWindow()">Ã—</button>
        </div>

        <div class="mode-indicator" id="modeIndicator">
            ç•¶å‰æ¨¡å¼: æ™ºèƒ½å®¢æœ
        </div>

        <!-- å¿«é€Ÿæ“ä½œå€åŸŸ -->
        <div class="quick-actions-wrapper">
            <button class="scroll-btn left" onclick="scrollQuickActions(-150)">&#10094;</button>
            <div class="quick-actions">
                <button class="quick-btn" onclick="handleQuickAction('orders')">
                    <i class="fas fa-box"></i> æˆ‘çš„è¨‚å–®
                </button>
                <button class="quick-btn" onclick="handleQuickAction('faq')">
                    <i class="fas fa-question-circle"></i> ç†±é–€å•é¡Œ
                </button>
                <button class="quick-btn" onclick="handleQuickAction('promotions')">
                    <i class="fas fa-gift"></i> æœ€æ–°æ´»å‹•
                </button>
                <button class="quick-btn" id="toggleModeBtn" onclick="toggleHumanMode()">
                    <i class="fas fa-headset"></i> äººå·¥å®¢æœ
                </button>
            </div>
            <button class="scroll-btn right" onclick="scrollQuickActions(150)">&#10095;</button>
        </div>

        <!-- èŠå¤©å…§å®¹ -->
        <div class="chat-box" id="chatBox">
            <!-- åˆå§‹æ­¡è¿è¨Šæ¯ -->
            <div class="message bot-message">
                <div class="avatar bot-avatar"><i class="fas fa-robot"></i></div>
                <div>
                    <div>æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œè«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨ï¼Ÿ</div>
                    <div class="timestamp" id="welcomeTimestamp"></div>
                </div>
            </div>
        </div>

        <!-- è¼¸å…¥è¡¨å–® -->
        <form id="chatForm" class="chat-input">
            <input type="text" id="message" placeholder="è¼¸å…¥è¨Šæ¯..." required>
            <button type="submit">å‚³é€</button>
        </form>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        let isHumanMode = false;
        let humanWebSocket = null;
        let chatHistory = [];
        const toggleModeBtn = document.getElementById('toggleModeBtn');
        const modeIndicator = document.getElementById('modeIndicator');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        // åˆå§‹åŒ–æ­¡è¿è¨Šæ¯çš„æ™‚é–“æˆ³
        document.getElementById('welcomeTimestamp').textContent = new Date().toLocaleTimeString();
        
        // åˆ‡æ›èŠå¤©è¦–çª—
        function toggleChatWindow() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.style.display = (chatContainer.style.display === 'none' || chatContainer.style.display === '') 
                ? 'block' 
                : 'none';
        }
        
        // æ»¾å‹•å¿«é€Ÿæ“ä½œæŒ‰éˆ•
        function scrollQuickActions(amount) {
            const quickActions = document.querySelector(".quick-actions");
            quickActions.scrollBy({ left: amount, behavior: "smooth" });
        }
        
        // å¿«é€ŸæŒ‰éˆ•è™•ç†
        function handleQuickAction(type) {
            if (type === 'customer-service') {
                toggleHumanMode();
                return;
            }
            
            const messages = {
                orders: 'æ‚¨çš„æœ€æ–°è¨‚å–®ç‹€æ…‹å¦‚ä¸‹ï¼š\nè¨‚å–®ç·¨è™Ÿï¼š#123456\nç‹€æ…‹ï¼šå·²å‡ºè²¨ ğŸšš\né è¨ˆé€é”æ™‚é–“ï¼š2023-12-15',
                faq: 'å¸¸è¦‹å•é¡Œï¼š\n1. å¦‚ä½•é€€è²¨ï¼Ÿ\n2. æœƒå“¡é»æ•¸å¦‚ä½•ä½¿ç”¨ï¼Ÿ\n3. å¦‚ä½•ä¿®æ”¹è¨‚å–®è³‡è¨Šï¼Ÿ\n4. ä»˜æ¬¾æ–¹å¼æœ‰å“ªäº›ï¼Ÿ',
                promotions: 'æœ€æ–°æ´»å‹•ï¼š\nğŸ”¥ é€±å¹´æ…¶å…¨é¤¨8æŠ˜ï¼\nğŸ æ¶ˆè²»æ»¿1000å…ƒé€100å…ƒè³¼ç‰©é‡‘ï¼\nğŸ’ æ–°æœƒå“¡é¦–è³¼äº«9æŠ˜å„ªæƒ ï¼'
            };
            
            if(messages[type]) {
                displayMessage(messages[type], 'bot');
            }
        }
        
        // åˆ‡æ›äººå·¥å®¢æœæ¨¡å¼
        function toggleHumanMode() {
            fetch('/chat/toggle-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                isHumanMode = !isHumanMode;
                updateModeUI();
                
                if (isHumanMode) {
                    initWebSocket();
                } else {
                    if (humanWebSocket) {
                        humanWebSocket.close();
                        humanWebSocket = null;
                    }
                }
            })
            .catch(error => console.error('åˆ‡æ›æ¨¡å¼å¤±æ•—:', error));
        }
        
        // åˆå§‹åŒ–WebSocketé€£æ¥
        function initWebSocket() {
            updateConnectionStatus('connecting', 'é€£æ¥ä¸­...');
            
            // æ›¿æ›ç‚ºæ‚¨çš„WebSocketç«¯é»
			humanWebSocket = new WebSocket('ws://localhost:8080/ws'); // éåŠ å¯†é€£ç·š
            
            humanWebSocket.onopen = function(e) {
                console.log('WebSocketé€£æ¥å·²å»ºç«‹');
                updateConnectionStatus('connected', 'äººå·¥å®¢æœå·²é€£æ¥');
            };
            
            humanWebSocket.onmessage = function(event) {
                displayMessage(event.data, 'human');
            };
            
            humanWebSocket.onclose = function(event) {
                console.log('WebSocketé€£æ¥å·²é—œé–‰');
                if (isHumanMode) {
                    updateConnectionStatus('disconnected', 'é€£æ¥å·²æ–·é–‹');
                    displayMessage('èˆ‡äººå·¥å®¢æœçš„é€£æ¥å·²æ–·é–‹ï¼Œå·²è‡ªå‹•åˆ‡å›æ™ºèƒ½å®¢æœ', 'bot');
                    toggleHumanMode();
                }
            };
            
            humanWebSocket.onerror = function(error) {
                console.error('WebSocketéŒ¯èª¤:', error);
                updateConnectionStatus('disconnected', 'é€£æ¥éŒ¯èª¤');
                if (isHumanMode) {
                    displayMessage('é€£æ¥äººå·¥å®¢æœæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œå·²è‡ªå‹•åˆ‡å›æ™ºèƒ½å®¢æœ', 'bot');
                    toggleHumanMode();
                }
            };
        }
        
        // æ›´æ–°é€£æ¥ç‹€æ…‹é¡¯ç¤º
        function updateConnectionStatus(status, text) {
            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }
        
        // æ›´æ–°æ¨¡å¼UI
        function updateModeUI() {
            if (isHumanMode) {
                modeIndicator.textContent = 'ç•¶å‰æ¨¡å¼: äººå·¥å®¢æœ';
                modeIndicator.classList.add('human-active');
                toggleModeBtn.innerHTML = '<i class="fas fa-robot"></i> æ™ºèƒ½å®¢æœ';
                toggleModeBtn.classList.remove('human-btn');
            } else {
                modeIndicator.textContent = 'ç•¶å‰æ¨¡å¼: æ™ºèƒ½å®¢æœ';
                modeIndicator.classList.remove('human-active');
                toggleModeBtn.innerHTML = '<i class="fas fa-headset"></i> äººå·¥å®¢æœ';
                toggleModeBtn.classList.add('human-btn');
                updateConnectionStatus('', 'æ™ºèƒ½å®¢æœ');
            }
        }
        
        // è¡¨å–®æäº¤è™•ç†
        document.getElementById("chatForm").addEventListener("submit", function(event) {
            event.preventDefault();
            const userMessage = document.getElementById("message").value.trim();
            
            if(userMessage) {
                displayMessage(userMessage, "user");
                document.getElementById("message").value = "";
                
                if (isHumanMode) {
                    if (humanWebSocket && humanWebSocket.readyState === WebSocket.OPEN) {
                        humanWebSocket.send(userMessage);
                    } else {
                        displayMessage('äººå·¥å®¢æœé€£æ¥å·²æ–·é–‹ï¼Œå·²è‡ªå‹•åˆ‡å›æ™ºèƒ½å®¢æœ', 'bot');
                        toggleHumanMode();
                    }
                } else {
                    sendToAI(userMessage);
                }
            }
        });
        
        // ç™¼é€åˆ°AI (RASA API)
        function sendToAI(message) {
            fetch('/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message }),
            })
            .then(response => response.json())
            .then(data => {
                displayMessage(data.botResponse, "bot");
            })
            .catch(error => {
                console.error('Error:', error);
                displayMessage('æŠ±æ­‰ï¼Œæš«æ™‚ç„¡æ³•è™•ç†æ‚¨çš„è«‹æ±‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'bot');
            });
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function displayMessage(message, sender) {
            const chatBox = document.getElementById("chatBox");
            const messageDiv = document.createElement("div");
            
            // æ ¹æ“šç™¼é€è€…æ±ºå®šæ¨£å¼
            let messageClass = '';
            let avatarClass = '';
            let icon = '';
            
            switch(sender) {
                case 'user':
                    messageClass = 'user-message';
                    avatarClass = 'user-avatar';
                    icon = 'fa-user';
                    break;
                case 'bot':
                    messageClass = 'bot-message';
                    avatarClass = 'bot-avatar';
                    icon = 'fa-robot';
                    break;
                case 'human':
                    messageClass = 'human-message';
                    avatarClass = 'human-avatar';
                    icon = 'fa-headset';
                    break;
            }
            
            messageDiv.className = `message ${messageClass}`;
            
            // å»ºç«‹é ­åƒ
            const avatar = document.createElement("div");
            avatar.className = `avatar ${avatarClass}`;
            avatar.innerHTML = `<i class="fas ${icon}"></i>`;
            
            // è¨Šæ¯å…§å®¹
            const content = document.createElement("div");
            const text = document.createElement("div");
            
            // è™•ç†æ›è¡Œé¡¯ç¤º
            message.split('\n').forEach((line, index) => {
                if (index > 0) {
                    text.appendChild(document.createElement('br'));
                }
                text.appendChild(document.createTextNode(line));
            });
            
            // æ™‚é–“æˆ³è¨˜
            const timestamp = document.createElement("div");
            timestamp.className = "timestamp";
            timestamp.textContent = new Date().toLocaleTimeString();
            
            // çµ„åˆå…ƒç´ 
            content.appendChild(text);
            content.appendChild(timestamp);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            chatBox.appendChild(messageDiv);
            
            // è‡ªå‹•æ»¾å‹•
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</div>