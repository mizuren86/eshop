<!DOCTYPE html>
<html
    lang="en"
    xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/base}"
>
    <head>
        <meta charset="utf-8" />
        <title>Cart - Fruitables</title>
    </head>
    <body>
        <!-- 此區塊會替換 base.html 中 layout:fragment="content" 的內容 -->
        <div layout:fragment="content">
            <!-- Single Page Header Start -->
            <div class="container-fluid page-header py-5">
                <h1 class="text-center text-white display-6">Cart</h1>
                <ol class="breadcrumb justify-content-center mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/index}">Home</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/pages}">Pages</a></li>
                    <li class="breadcrumb-item active text-white">Cart</li>
                </ol>
            </div>
            <!-- Single Page Header End -->

            <!-- Cart Page Start -->
            <div class="container-fluid py-5">
                <div class="container py-5">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col" class="align-middle text-center"></th>
                                    <th scope="col" class="align-middle text-center">品名</th>
                                    <th scope="col" class="align-middle text-center">價格</th>
                                    <th scope="col" class="align-middle text-center">數量</th>
                                    <th scope="col" class="align-middle text-center">總價</th>
                                    <th scope="col" class="align-middle text-center"></th>
                                </tr>
                            </thead>
                            <tbody id="cart-items">
                                <!-- 購物車項目將透過 fetch API 動態填充 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-5">
                        <input
                            type="text"
                            class="border-0 border-bottom rounded me-5 py-3 mb-4"
                            placeholder="Coupon Code"
                        />
                        <button
                            class="btn border-secondary rounded-pill px-4 py-3 text-primary"
                            type="button"
                        >
                            Apply Coupon
                        </button>
                    </div>
                    <div class="row g-4 justify-content-end">
                        <div class="col-8"></div>
                        <div class="col-sm-8 col-md-7 col-lg-6 col-xl-4">
                            <div class="bg-light rounded">
                                <div class="p-4">
                                    <h1 class="display-6 mb-4">結帳明細</h1>
                                    <div class="d-flex justify-content-between mb-4">
                                        <h5 class="mb-0 me-4">小計：</h5>
                                        <p id="total-amount" class="mb-0">$0.00</p>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <h5 class="mb-0 me-4">優惠券：</h5>
                                        <div class="">
                                            <p class="mb-0">- $300.00</p>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="py-4 mb-4 border-top border-bottom d-flex justify-content-between"
                                >
                                    <h5 class="mb-0 ps-4 me-4">結帳金額</h5>
                                    <p id="grand-total" class="mb-0 pe-4">$0.00</p>
                                </div>
                                <a
                                    th:href="@{/checkout}"
                                    class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase mb-4 ms-4"
                                >
                                    去買單
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Cart Page End -->

            <!-- 使用 fetch API 從 REST API 取得購物車資料 -->
            <script th:inline="javascript">
                /*<![CDATA[*/
                // 異步取得購物車資料並更新頁面
                async function loadCartData() {
                    try {
                        const response = await fetch("/api/cart");
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        const data = await response.json();
                        const cartItems = data.cartItems;
                        const totalAmount = parseFloat(data.totalAmount);
                        const cartItemsContainer = document.getElementById("cart-items");
                        cartItemsContainer.innerHTML = "";

                        cartItems.forEach((item) => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
            <th scope="row" class="align-middle text-center">
              <div class="d-flex align-items-center justify-content-center">
                <img src="${item.product.imageUrl}" class="img-fluid me-5 rounded-circle" style="width: 80px; height: 80px;" alt="">
              </div>
            </th>
            <td class="align-middle text-center"><p class="mb-0">${item.product.productName}</p></td>
            <td class="align-middle text-center"><p class="mb-0">$${item.price}</p></td>
            <td class="align-middle text-center">
			  <div class="input-group quantity d-flex align-items-center justify-content-center mx-auto" style="width: 100px;">
                <div class="input-group-btn">
                  <button class="btn btn-sm btn-minus rounded-circle bg-light border" onclick="updateQuantity(${item.cartItemId}, -1)">
                    <i class="fa fa-minus"></i>
                  </button>
                </div>
                <input type="text" id="quantity-${item.cartItemId}" class="form-control form-control-sm text-center border-0" value="${item.quantity}">
                <div class="input-group-btn">
                  <button class="btn btn-sm btn-plus rounded-circle bg-light border" onclick="updateQuantity(${item.cartItemId}, 1)">
                    <i class="fa fa-plus"></i>
                  </button>
                </div>
              </div>
            </td>
            <td class="align-middle text-center"><p class="mb-0">$${item.subTotal}</p></td>
            <td class="align-middle text-center">
              <button class="btn btn-md rounded-circle bg-light border" onclick="removeCartItem(${item.cartItemId})">
                <i class="fa fa-trash text-danger"></i>
              </button>
            </td>
          `;
                            cartItemsContainer.appendChild(row);
                        });

                        // 更新總金額及計算最終總金額 (扣除優惠券的價格)
                        document.getElementById("total-amount").textContent = "$" + totalAmount.toFixed(2);
                        const grandTotal = totalAmount - 300.0;
                        document.getElementById("grand-total").textContent = "$" + grandTotal.toFixed(2);
                    } catch (error) {
                        console.error("Error fetching cart data:", error);
                    }
                }

                // 使用 fetch API 移除購物車項目
                async function removeCartItem(cartItemId) {
                    try {
                        const response = await fetch(`/api/cart/remove?cartItemId=${cartItemId}`, {
                            method: "POST",
                        });
                        if (!response.ok) {
                            throw new Error("Error removing cart item");
                        }
                        // 重新載入購物車資料
                        loadCartData();
                    } catch (error) {
                        console.error("Error removing cart item:", error);
                    }
                }

                // 使用 fetch API 更新購物車項目數量
                async function updateQuantity(cartItemId, delta) {
                    try {
                        const quantityInput = document.getElementById(`quantity-${cartItemId}`);
                        let currentQuantity = parseInt(quantityInput.value);
                        let newQuantity = currentQuantity + delta;
                        if (newQuantity < 1) {
                            newQuantity = 1;
                        }
                        const response = await fetch(
                            `/api/cart/update?cartItemId=${cartItemId}&quantity=${newQuantity}`,
                            {
                                method: "POST",
                            }
                        );
                        if (!response.ok) {
                            throw new Error("Error updating quantity");
                        }
                        // 更新頁面資料
                        loadCartData();
                    } catch (error) {
                        console.error("Error updating cart item quantity:", error);
                    }
                }

                window.loadCartData = loadCartData;
                window.updateQuantity = updateQuantity;
                window.removeCartItem = removeCartItem;

                document.addEventListener("DOMContentLoaded", loadCartData);
                /*]]>*/
            </script>
        </div>
    </body>
</html>
