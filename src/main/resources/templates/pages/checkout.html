<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/base}">

<head>
	<meta charset="utf-8" />
	<title>Checkout - Fruitables</title>
	<style>
		.hidden {
			display: none !important;
		}

		.checkout-block {
			border: 1px solid #ccc;
			padding: 1rem;
			margin-bottom: 1rem;
		}

		.shipping-note {
			margin-top: 1rem;
			font-size: 0.9rem;
			color: #555;
		}


		/* 下拉選單移除預設箭頭 */
		.select-wrapper select {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
		}

		/* position-relative 供箭頭絕對定位 */
		.select-wrapper {
			position: relative;
			display: inline-block;
			width: 100%;
		}

		/* 箭頭位置設定 */
		.select-wrapper .fa-caret-down {
			position: absolute;
			top: 50%;
			right: 1rem;
			transform: translateY(-50%);
			pointer-events: none;
		}

		/* 讓 select 右側預留空間給箭頭 */
		.pe-arrow {
			padding-right: 2rem !important;
		}

		/* <select> 被 disabled 時的樣式 */
		select:disabled {
			background-color: #e0e0e0;
			/* 背景顏色 */
			color: #888;
			/* 文字顏色 */
			cursor: not-allowed;
			/* 滑鼠指標顯示禁止符號 */
			opacity: 0.8;
			/* 文字透明度 */
		}

		/* 運費提示區塊設定 */
		#cartShippingFeeAlert {
			width: 300px;
			min-height: 2rem;
		}

		/* placeholder 樣式 */
		#customerPhone::placeholder,
		#recipientPhone::placeholder,
		#shippingAddress::placeholder {
			color: lightgray;
		}

		#customerPhone::-webkit-input-placeholder,
		#recipientPhone::-webkit-input-placeholder {
			color: lightgray;
		}

		#customerPhone:-ms-input-placeholder,
		#recipientPhone:-ms-input-placeholder {
			color: lightgray;
		}

		table tfoot td {
			border: none;
		}

		.shipping-fee-placeholder {
			background-color: #eaf8ff;
			color: #0d6efd;
			padding: 4px 8px;
			border-radius: 4px;
		}
	</style>
</head>

<body>
	<div layout:fragment="content">
		<!-- Header -->
		<div class="container-fluid page-header py-5">
			<h1 class="text-center text-white display-6">Checkout</h1>
			<ol class="breadcrumb justify-content-center mb-0">
				<li class="breadcrumb-item"><a th:href="@{/index}">Home</a></li>
				<li class="breadcrumb-item"><a th:href="@{/cart}">Cart</a></li>
				<li class="breadcrumb-item active text-white">Checkout</li>
			</ol>
		</div>



		<!-- Checkout Page -->
		<div class="container py-5" id="checkoutPage">

			<!-- 購物車清單 -->
			<section class="cart-table-section card p-4 mb-4">
				<h4 class="mb-3">購物車</h4>
				<div class="table-responsive">
					<table class="table">
						<thead>
							<tr>
								<th class="text-center"></th>
								<th class="text-center">品名</th>
								<th class="text-center">價格</th>
								<th class="text-center">數量</th>
								<th class="text-center">小計</th>
							</tr>
						</thead>
						<tbody id="cartItems">
							<!-- 由 fetchCartData() 動態生成 -->
						</tbody>
						<tfoot>
							<tr>
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>小計：</strong></td>
								<td id="subtotalAmount" class="text-center align-middle" style="width:200px;">
									<strong>$0</strong>
								</td>
							</tr>
							<tr id="cartShippingRow">
								<td colspan="3"></td>
								<td class="text-end align-middle">
									<strong>運費：</strong>
								</td>
								<td id="cartShippingFee" class="text-center align-middle" style="width:200px;">
									<div id="cartShippingFeeAlert" class="alert alert-info mb-0" role="alert">
										將於確認送貨地址後顯示運費
									</div>
								</td>
							</tr>

							<!-- 優惠券折扣列，預設隱藏，由 JS 控制顯示 -->
							<tr id="couponDiscountRow" style="display: none;">
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>優惠券：</strong></td>
								<td id="couponDiscount" class="text-center align-middle" style="width:200px;">
									<strong>-$0</strong>
								</td>
							</tr>
							<tr>
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>合計：</strong></td>
								<td id="grandTotal" class="text-center align-middle" style="width:200px;">
									<strong>$0</strong>
								</td>
							</tr>
						</tfoot>
					</table>
				</div>
			</section>

			<div th:switch="${shippingMethod}">
				<!-- 1) 7-11 取貨付款 (付現取貨) -->
				<div th:case="'711-cod'">
					<div class="row">
						<!-- 左欄：顧客資料與訂單備註 -->
						<div class="col-md-6">
							<div class="card p-3 mb-4">
								<h4 class="mb-3">顧客資料</h4>
								<div class="mb-3">
									<label for="customerName" class="form-label">顧客姓名</label>
									<input type="text" class="form-control" id="customerName" name="customerName"
										placeholder="" th:value="${users.username}" />
								</div>
								<div class="mb-3">
									<label for="customerEmail" class="form-label">電子信箱</label>
									<input type="email" class="form-control" id="customerEmail" name="customerEmail"
										placeholder="" th:value="${users.email}" />
									<div class="form-text mt-2">
										請填入訂單通知Email (訂單資訊將以此E-mail通知您)
									</div>
								</div>
								<div class="mb-3">
									<label for="customerPhone" class="form-label">電話號碼</label>
									<input type="text" class="form-control" id="customerPhone" name="customerPhone"
										placeholder="0912 345 678" th:value="${users.phone}" />
								</div>
							</div>
							<div class="card p-3">
								<h4 class="mb-3">訂單備註</h4>
								<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
									placeholder="有什麼想告訴賣家嗎"></textarea>
							</div>
						</div>
						<!-- 右欄：送貨資料與付款資料 -->
						<div class="col-md-6">
							<div class="card p-3 mb-4">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h4 class="mb-0">送貨資料</h4>
									<p class="shippingCardFeeText mb-0">$60</p>
								</div>
								<p class="mb-1">
									已選擇的送貨方式: 7-11 取貨付款（寄出日系統會發電子郵件通知，
									一般寄出日+2日會抵達門市）<br />
								</p>
								<div class="mb-3 mt-2">
									<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
									<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
								</div>
								<div class="mb-3 mt-3">
									<label for="recipientName" class="form-label">收件人姓名</label>
									<input type="text" class="form-control" id="recipientName" name="recipientName"
										placeholder="" />
									<div class="form-text mt-2">
										請填入收件人真實姓名，以確保順利收件
									</div>
								</div>
								<div class="mb-3">
									<label for="recipientPhone" class="form-label">收件人電話號碼</label>
									<input type="text" class="form-control" id="recipientPhone" name="recipientPhone"
										placeholder="0912 345 678" />
								</div>
								<button type="button" class="btn btn-outline-secondary">選擇門市</button>
							</div>
							<div class="card p-3">
								<div class="d-flex justify-content-between align-items-center mb-3">
									<h4 class="mb-0">付款資料</h4>
									<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
								</div>
								<p class="m-0">
									已選擇的付款方式: 7-11 取貨付款（包裹抵達指定門市後，付現取貨）
								</p>
							</div>
						</div>
					</div>
				</div>

				<!-- 2) 7-11 取貨不付款 -->
				<div th:case="'711-no-cod'">
					<div th:switch="${paymentMethod}">
						<!-- 2-1) 7-11 取貨不付款 + LINE PAY -->
						<div th:case="'linepay'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">$60</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 7-11 取貨不付款（寄出日系統會發電子郵件通知，
											一般寄出日+2日會抵達門市）<br />
										</p>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<button type="button" class="btn btn-outline-secondary">選擇門市</button>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<!-- 固定顯示 LINE Pay -->
										<p class="m-0">已選擇的付款方式: LINE Pay</p>
									</div>
								</div>
							</div>
						</div>
						<!-- 2-2) 7-11 取貨不付款 + 信用卡 -->
						<div th:case="'credit'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">$60</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 7-11 取貨不付款（寄出日系統會發電子郵件通知，
											一般寄出日+2日會抵達門市）<br />
										</p>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<button type="button" class="btn btn-outline-secondary">選擇門市</button>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<!-- 固定顯示信用卡 -->
										<p class="m-0">已選擇的付款方式: 信用卡</p>
									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
				<!-- 3) 新竹貨運 -->
				<div th:case="'hct'">
					<div th:switch="${paymentMethod}">
						<!-- 3-1) 新竹貨運 + LINE PAY -->
						<div th:case="'linepay'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 新竹貨運<br />
										</p>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<hr />
										<div class="mb-3 mt-3">
											<label class="form-label">地址</label>
											<div class="dropdown-container"
												style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
												<!-- 城市/縣下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="city" class="form-control pe-arrow">
														<!-- 動態生成城市/縣選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
												<!-- 地區下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="district" class="form-control pe-arrow">
														<!-- 動態生成地區選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
											</div>
											<input type="text" class="form-control" id="shippingAddress"
												name="shippingAddress" placeholder="地址" />
										</div>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<p class="m-0">已選擇的付款方式: LINE PAY</p>
									</div>
								</div>
							</div>
						</div>
						<!-- 3-2) 新竹貨運 + 信用卡 -->
						<div th:case="'credit'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 新竹貨運<br />
										</p>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<hr />
										<div class="mb-3 mt-3">
											<label class="form-label">地址</label>
											<div class="dropdown-container"
												style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
												<!-- 城市/縣下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="city" class="form-control pe-arrow">
														<!-- 動態生成城市/縣選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
												<!-- 地區下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="district" class="form-control pe-arrow">
														<!-- 動態生成地區選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
											</div>
											<input type="text" class="form-control" id="shippingAddress"
												name="shippingAddress" placeholder="地址" />
										</div>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<p class="m-0">已選擇的付款方式: 信用卡</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- outer-island 區塊 -->
				<div th:case="'outer-island'">
					<div th:switch="${paymentMethod}">
						<!-- 外島郵寄 + LINE PAY -->
						<div th:case="'linepay'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 外島郵寄<br />
										</p>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<hr />
										<div class="mb-3 mt-3">
											<label class="form-label">地址</label>
											<div class="dropdown-container"
												style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
												<!-- 城市/縣下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="city" class="form-control pe-arrow">
														<!-- 動態生成城市/縣選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
												<!-- 地區下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="district" class="form-control pe-arrow">
														<!-- 動態生成地區選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
											</div>
											<input type="text" class="form-control" id="shippingAddress"
												name="shippingAddress" placeholder="地址" />
										</div>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<p class="m-0">已選擇的付款方式: LINE PAY</p>
									</div>
								</div>
							</div>
						</div>
						<!-- 外島郵寄 + 信用卡 -->
						<div th:case="'credit'">
							<div class="row">
								<!-- 左欄：顧客資料與訂單備註 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<h4 class="mb-3">顧客資料</h4>
										<div class="mb-3">
											<label for="customerName" class="form-label">顧客姓名</label>
											<input type="text" class="form-control" id="customerName"
												name="customerName" placeholder="" th:value="${users.username}" />
										</div>
										<div class="mb-3">
											<label for="customerEmail" class="form-label">電子信箱</label>
											<input type="email" class="form-control" id="customerEmail"
												name="customerEmail" placeholder="" th:value="${users.email}" />
											<div class="form-text mt-2">
												請填入訂單通知Email (訂單資訊將以此E-mail通知您)
											</div>
										</div>
										<div class="mb-3">
											<label for="customerPhone" class="form-label">電話號碼</label>
											<input type="text" class="form-control" id="customerPhone"
												name="customerPhone" placeholder="0912 345 678"
												th:value="${users.phone}" />
										</div>
									</div>
									<div class="card p-3">
										<h4 class="mb-3">訂單備註</h4>
										<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
											placeholder="有什麼想告訴賣家嗎"></textarea>
									</div>
								</div>
								<!-- 右欄：送貨資料與付款資料 -->
								<div class="col-md-6">
									<div class="card p-3 mb-4">
										<!-- 新增「送貨地址」欄位 -->
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">送貨資料</h4>
											<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
										</div>
										<p class="mb-1">
											已選擇的送貨方式: 外島郵寄<br />
										</p>
										<div class="mb-3">
											<label for="shippingAddress" class="form-label">送貨地址</label>
											<input type="text" class="form-control" id="shippingAddress"
												name="shippingAddress" placeholder="請輸入詳細送貨地址" />
										</div>
										<div class="mb-3 mt-2">
											<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
											<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
										</div>
										<div class="mb-3 mt-3">
											<label for="recipientName" class="form-label">收件人姓名</label>
											<input type="text" class="form-control" id="recipientName"
												name="recipientName" placeholder="" />
											<div class="form-text mt-2">
												請填入收件人真實姓名，以確保順利收件
											</div>
										</div>
										<div class="mb-3">
											<label for="recipientPhone" class="form-label">收件人電話號碼</label>
											<input type="text" class="form-control" id="recipientPhone"
												name="recipientPhone" placeholder="0912 345 678" />
										</div>
										<hr />
										<div class="mb-3 mt-3">
											<label class="form-label">地址</label>
											<div class="dropdown-container"
												style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
												<!-- 城市/縣下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="city" class="form-control pe-arrow">
														<!-- 動態生成城市/縣選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
												<!-- 地區下拉選單 -->
												<div class="form-group select-wrapper">
													<select id="district" class="form-control pe-arrow">
														<!-- 動態生成地區選項 -->
													</select>
													<i class="fa fa-caret-down position-absolute"
														style="top: 50%; right: 1rem; transform: translateY(-50%);"></i>
												</div>
											</div>
											<input type="text" class="form-control" id="shippingAddress"
												name="shippingAddress" placeholder="地址" />
										</div>
									</div>
									<div class="card p-3">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="mb-0">付款資料</h4>
											<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
										</div>
										<p class="m-0">已選擇的付款方式: 信用卡</p>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>


				<!-- 下方按鈕 -->
				<div style="display: flex; justify-content: space-between" class="mt-4">
					<button id="backToCart"
						class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase">
						返回購物車
					</button>
					<button id="submitOrder"
						class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase">
						提交訂單
					</button>
				</div>
			</div>
			<!-- Checkout Page End -->

			<script th:inline="javascript">
				/*<![CDATA[*/
				// 運費預設值
				var fixedShippingFee = 60;
				// 全域變數：保存購物車小計
				let currentSubtotal = 0;
				// 優惠券折扣（假設從 Session 拿到，若無則為 0）
				var couponDiscountOverall = /*[[${couponDiscount != null ? couponDiscount : 0}]]*/ 0;

				// 根據 cartItems 陣列計算小計
				function recalcSubtotal(cartItems) {
					return cartItems.reduce((sum, item) => sum + item.subTotal, 0);
				}

				// 計算運費邏輯，回傳運費金額
				function getShippingFee() {
					// 運送方式是 7-11 取貨付款或7-11 取貨不付款，固定運費 60
					if (shippingMethod === "711-cod" || shippingMethod === "711-no-cod") {
						return fixedShippingFee;
					}

					const citySelect = document.getElementById("city");
					const districtSelect = document.getElementById("district");
					const selectedCity = citySelect.value;
					const selectedDistrict = districtSelect.value;
					if (!selectedDistrict) {
						return 0;
					}
					let fee = 0;
					if (shippingMethod === "outer-island") {
						fee = 100;
						if (selectedCity === "澎湖縣") {
							fee = 120;
						} else if (selectedCity === "金門縣" || selectedCity === "連江縣") {
							fee = 150;
						}
					} else if (shippingMethod === "hct") {
						fee = 80;
						if (selectedCity === "臺東縣") {
							fee = 85;
						} else if (selectedCity === "花蓮縣") {
							fee = 90;
						}
					} else {
						fee = fixedShippingFee;
					}
					return fee;
				}

				// 更新送貨資料卡片中的運費顯示
				function updateShippingCardFee() {
					console.log("updateShippingCardFee: shippingMethod =", shippingMethod);
					// 如果為固定運費方式，直接設定文字並回傳固定費用
					if (shippingMethod === "711-cod" || shippingMethod === "711-no-cod") {
						document.querySelectorAll(".shippingCardFeeText").forEach(el => {
							el.textContent = "運費 NT$" + fixedShippingFee;
						});
						return fixedShippingFee;
					}
					// 否則依照下拉選單判斷
					const districtSelect = document.getElementById("district");
					const fee = getShippingFee();
					const feeText = (districtSelect.value === "") ? "將於確認送貨地址後顯示運費" : "運費 NT$" + fee;
					document.querySelectorAll(".shippingCardFeeText").forEach(el => {
						el.textContent = feeText;
					});
					return fee;
				}

				// 更新購物車表格中的運費列
				function updateCartShippingFeeUI() {
					if (shippingMethod === "711-cod" || shippingMethod === "711-no-cod") {
						document.getElementById("cartShippingFeeAlert").textContent = "NT$" + fixedShippingFee;
						return fixedShippingFee;
					}

					const districtSelect = document.getElementById("district");
					if (districtSelect.value === "") {
						document.getElementById("cartShippingFeeAlert").textContent = "將於確認送貨地址後顯示運費";
						return 0;
					} else {
						const fee = getShippingFee();
						document.getElementById("cartShippingFeeAlert").textContent = "NT$" + fee;
						return fee;
					}
				}

				// 更新合計金額：購物車小計 + 運費 - 優惠券折扣，同時控制優惠券行顯示
				function updateGrandTotal() {
					const subtotal = parseInt(document.getElementById("subtotalAmount").textContent.replace("$", "")) || 0;
					const shippingFee = updateCartShippingFeeUI();
					const grandTotalValue = subtotal + shippingFee - couponDiscountOverall;
					document.getElementById("grandTotal").textContent = "$" + grandTotalValue;
					document.getElementById("paymentGrandTotal").textContent = "$" + grandTotalValue;
					// 更新優惠券行：若優惠折扣大於 0，顯示該行；否則隱藏
					const couponRow = document.getElementById("couponDiscountRow");
					if (couponDiscountOverall > 0) {
						couponRow.style.display = "table-row";
						document.getElementById("couponDiscount").textContent = "-$" + couponDiscountOverall;
					} else {
						couponRow.style.display = "none";
					}
				}

				// 從 API 拿購物車資料並更新頁面
				async function fetchCartData() {
					try {
						const response = await fetch("/api/cart");
						if (!response.ok) throw new Error("Network response was not ok");
						const {cartItems, totalAmount} = await response.json();
						currentSubtotal = recalcSubtotal(cartItems);
						const cartItemsContainer = document.getElementById("cartItems");
						cartItemsContainer.innerHTML = "";
						cartItems.forEach((item) => {
							const storedQuantity = sessionStorage.getItem("cartItem_" + item.cartItemId);
							if (storedQuantity !== null) {
								item.quantity = parseInt(storedQuantity);
								item.subTotal = item.price * item.quantity;
							}
							const row = document.createElement("tr");
							row.innerHTML = `
				              <td class="text-center align-middle">
				                <img src="${item.product.imageUrl}" alt="" class="img-fluid rounded-circle" style="width:80px; height:80px;">
				              </td>
				              <td class="text-center align-middle">${item.product.productName}</td>
				              <td class="text-center align-middle">$${item.price}</td>
				              <td class="text-center align-middle">
				                <div class="d-flex justify-content-center align-items-center mx-auto" style="width:100px;">
				                  <span id="quantity-${item.cartItemId}" class="text-center">${item.quantity}</span>
				                </div>
				              </td>
				              <td class="text-center align-middle">$${item.subTotal}</td>
				            `;
							cartItemsContainer.appendChild(row);
						});
						document.getElementById("subtotalAmount").textContent = "$" + currentSubtotal;
						updateGrandTotal();
					} catch (error) {
						console.error("Error fetching cart data:", error);
					}
				}

				// 假設 shippingMethod 由後端傳入，若無則預設為 "711-cod"
				var shippingMethod = /*[[${shippingMethod}]]*/ "711-cod";

				// 地址下拉選單與運費更新邏輯
				document.addEventListener("DOMContentLoaded", function () {
					// 定義城市與地區對應資料
					var hctCityDistricts = {
						"台北市": ["100中正區", "103大同區", "104中山區", "105松山區", "106大安區",
							"108萬華區", "110信義區", "111士林區", "112北投區", "114內湖區",
							"115南港區", "116文山區"],
						"基隆市": ["200仁愛區", "201信義區", "202中正區", "203中山區", "204安樂區",
							"205暖暖區", "206七堵區"],
						"新北市": ["207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"223石碇區", "224瑞芳區", "226平溪區", "227雙溪區", "228貢寮區",
							"231新店區", "232坪林區", "233烏來區", "234永和區", "235中和區",
							"236土城區", "237三峽區", "238樹林區", "239鶯歌區", "241三重區",
							"242新莊區", "243泰山區", "244林口區", "247蘆洲區", "248五股區",
							"249八里區", "251淡水區", "252三芝區", "253石門區"],
						"宜蘭縣": ["207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"207萬里區", "208金山區"],
						"新竹縣": ["300北區", "300東區", "300香山區"],
						"新竹市": ["302竹北區", "303湖口鄉", "304新豐鄉", "305新埔鎮", "306關西鎮",
							"307芎林鄉", "308寶山鄉", "310竹東鎮", "311五峰鄉", "312橫山鄉",
							"313尖石鄉", "314北埔鄉", "315峨眉鄉"],
						"桃園市": ["320中壢區", "324平鎮區", "325龍潭區", "326楊梅區", "327新屋區",
							"328觀音區", "330桃園區", "333龜山區", "334八德區", "335大溪區",
							"336復興區", "337大園區", "338蘆竹區"],
						"苗栗縣": ["350竹南鎮", "351頭份市", "352三灣鄉", "353南庄鄉", "354獅潭鄉",
							"356後龍鎮", "357通霄鎮", "358苑裡鎮", "360苗栗市", "361造橋鄉",
							"362頭屋鄉", "363公館鄉", "364大湖鄉", "365泰安鄉", "366銅鑼鄉",
							"367三義鄉", "368西湖鄉", "369卓蘭鎮"],
						"台中市": ["400中區", "401東區", "402南區", "403西區", "404北區",
							"406北屯區", "407西屯區", "408南屯區", "411太平區", "412大里區",
							"413霧峰區", "414烏日區", "420豐原區", "421后里區", "422石岡區",
							"423東勢區", "424和平區", "426新社區", "427潭子區", "428大雅區",
							"429神岡區", "432大肚區", "433沙鹿區", "434龍井區", "435梧棲區",
							"436清水區", "437大甲區", "438外埔區", "439大安區"],
						"彰化縣": ["500彰化市", "502芬園鄉", "503花壇鄉", "504秀水鄉", "505鹿港鎮",
							"506福興鄉", "507線西鄉", "508和美鎮", "509伸港鄉", "510員林市",
							"511社頭鄉", "512永靖鄉", "513埔心鄉", "514溪湖鎮", "515大村鄉",
							"516埔鹽鄉", "520田中鎮", "521北斗鎮", "522田尾鄉", "523埤頭鄉",
							"524溪州鄉", "525竹塘鄉", "526二林鎮", "527大城鄉", "528芳苑鄉",
							"530二水鄉"],
						"南投縣": ["540南投市", "541中寮鄉", "542草屯鎮", "544國姓鄉", "545埔里鎮",
							"546仁愛鄉", "551名間鄉", "552集集鎮", "553水里鄉", "555魚池鄉",
							"556信義鄉", "557竹山鎮", "558鹿谷鄉"],
						"嘉義市": ["600東區", "600大西區"],
						"嘉義縣": ["602番路鄉", "603梅山鄉", "604竹崎鄉", "605阿里山鄉", "606中埔鄉",
							"607大埔鄉", "608水上鄉", "611鹿草鄉", "612太保市", "613朴子市",
							"614東石鄉", "615六腳鄉", "616新港鄉", "621民雄鄉", "622大林鎮",
							"623溪口鄉", "624義竹鄉", "625布袋鎮"],
						"雲林縣": ["630斗南鎮", "631大埤鄉", "632虎尾鎮", "633土庫鎮", "634褒忠鄉",
							"635東勢鄉", "636臺西鄉", "637崙背鄉", "638麥寮鄉", "640斗六市",
							"643林內鄉", "646古坑鄉", "647莿桐鄉", "648西螺鎮", "649二崙鄉",
							"651北港鎮", "652水林鄉", "653口湖鄉", "654四湖鄉", "655元長鄉"],
						"台南市": ["700中西區", "701東區", "702南區", "704北區", "708安平區",
							"709安南區", "710永康區", "711歸仁區", "712新化區", "713左鎮區",
							"714玉井區", "715楠西區", "716南化區", "717仁德區", "718關廟區",
							"719龍崎區", "720官田區", "721麻豆區", "722佳里區", "723西港區",
							"724七股區", "725將軍區", "726學甲區", "727北門區", "730新營區",
							"731後壁區", "732白河區", "733東山區", "734六甲區", "735下營區",
							"736柳營區", "737鹽水區", "741善化區", "742大內區", "743山上區",
							"744新市區", "745安定區"],
						"高雄市": ["800新興區", "801前金區", "802苓雅區", "803鹽埕區", "804鼓山區",
							"805旗津區", "806前鎮區", "807三民區", "811楠梓區", "812小港區",
							"813左營區", "814仁武區", "815大社區", "820岡山區", "821路竹區",
							"822阿蓮區", "823田寮區", "824燕巢區", "825橋頭區", "826梓官區",
							"827彌陀區", "828永安區", "829湖內區", "830鳳山區", "831大寮區",
							"832林園區", "833鳥松區", "840大樹區", "842旗山區", "843美濃區",
							"844六龜區", "845內門區", "846杉林區", "847甲仙區", "848桃源區",
							"849那瑪夏區", "851茂林區", "852茄萣區"],
						"屏東縣": ["900屏東市", "901三地門鄉", "902霧臺鄉", "903瑪家鄉", "904九如鄉",
							"905里港鄉", "906高樹鄉", "907鹽埔鄉", "908長治鄉", "909麟洛鄉",
							"911竹田鄉", "912內埔鄉", "913萬丹鄉", "920潮州鎮", "921泰武鄉",
							"922來義鄉", "923萬巒鄉", "924崁頂鄉", "925新埤鄉", "926南州鄉",
							"927林邊鄉", "928東港鎮", "931佳冬鄉", "932新園鄉", "940枋寮鄉",
							"941枋山鄉", "942春日鄉", "943獅子鄉", "944車城鄉", "945牡丹鄉",
							"946恆春鎮", "947滿州鄉"],
						"臺東縣": ["950臺東市", "953延平鄉", "954卑南鄉", "955鹿野鄉", "956關山鎮",
							"957海端鄉", "958池上鄉", "959東河鄉", "961成功鎮", "962長濱鄉",
							"963太麻里鄉", "964金峰鄉", "965大武鄉", "966達仁鄉"],
						"花蓮縣": ["970花蓮市", "971新城鄉", "972秀林鄉", "973吉安鄉", "974壽豐鄉",
							"975鳳林鎮", "976光復鄉", "977豐濱鄉", "978瑞穗鄉", "979萬榮鄉",
							"981玉里鎮", "982卓溪鄉", "983富里鄉"]
					};

					var outerIslandCityDistricts = {
						"屏東縣": ["929琉球鄉"],
						"台東縣": ["951綠島鄉", "952蘭嶼鄉"],
						"澎湖縣": ["880馬公市", "881西嶼鄉", "882望安鄉", "883七美鄉", "884白沙鄉", "885湖西鄉"],
						"金門縣": ["890金沙鎮", "891金湖鄉", "892金寧鄉", "893金城鄉", "894烈嶼鄉", "896烏坵鄉"],
						"連江縣": ["209南竿鄉", "210北竿鄉", "211莒光鄉", "212東引鄉"]
					};

					// 根據 shippingMethod 選擇使用的地址資料
					var addressOptions = (shippingMethod === "outer-island") ? outerIslandCityDistricts : hctCityDistricts;
					var citySelect = document.getElementById("city");
					var districtSelect = document.getElementById("district");

					// 初始化城市下拉選單提示
					citySelect.innerHTML = "";
					var defaultCityOption = document.createElement("option");
					defaultCityOption.value = "";
					defaultCityOption.textContent = "城市/縣";
					defaultCityOption.disabled = true;
					defaultCityOption.selected = true;
					citySelect.appendChild(defaultCityOption);

					// 初始化區下拉選單提示
					districtSelect.innerHTML = "";
					var defaultDistOption = document.createElement("option");
					defaultDistOption.value = "";
					defaultDistOption.textContent = "地區";
					defaultDistOption.disabled = true;
					defaultDistOption.selected = true;
					districtSelect.appendChild(defaultDistOption);
					districtSelect.disabled = true;

					// 填入城市選項
					for (var city in addressOptions) {
						var option = document.createElement("option");
						option.value = city;
						option.textContent = city;
						citySelect.appendChild(option);
					}

					// 當城市選項改變時，更新區選單及重置運費提示
					function updateDistrictOptions() {
						// 如果為固定運費方式，直接更新並 return
						if (shippingMethod === "711-cod" || shippingMethod === "711-no-cod") {
							document.querySelectorAll(".shippingCardFeeText").forEach(el => {
								el.textContent = "運費 NT$" + fixedShippingFee;
							});
							updateCartShippingFeeUI();
							updateGrandTotal();
							return;
						}

						var selectedCity = citySelect.value;
						var districts = addressOptions[selectedCity] || [];
						if (!selectedCity) {
							districtSelect.innerHTML = "";
							var defaultDist = document.createElement("option");
							defaultDist.value = "";
							defaultDist.textContent = "地區";
							defaultDist.disabled = true;
							defaultDist.selected = true;
							districtSelect.appendChild(defaultDist);
							districtSelect.disabled = true;
							return;
						}
						districtSelect.innerHTML = "";
						districtSelect.disabled = false;
						var defaultDistOption = document.createElement("option");
						defaultDistOption.value = "";
						defaultDistOption.textContent = "地區";
						defaultDistOption.disabled = true;
						defaultDistOption.selected = true;
						districtSelect.appendChild(defaultDistOption);

						districts.forEach(function (dist) {
							var option = document.createElement("option");
							option.value = dist;
							option.textContent = dist;
							districtSelect.appendChild(option);
						});

						// 更新運費顯示
						updateShippingCardFee();
						updateCartShippingFeeUI();
						updateGrandTotal();
					}
					citySelect.addEventListener("change", updateDistrictOptions);
					districtSelect.addEventListener("change", function () {
						// 更新送貨資料卡片運費
						updateShippingCardFee();
						// 更新購物車運費
						updateCartShippingFeeUI();
						updateGrandTotal();
					});
					updateDistrictOptions();
				});

				// 重新載入購物車資料
				document.addEventListener("DOMContentLoaded", fetchCartData);

				/*]]>*/
			</script>

			<!-- 返回購物車、收件人資料複製 -->
			<script>
				document.addEventListener("DOMContentLoaded", function () {
					document.getElementById("backToCart").addEventListener("click", function () {
						window.location.href = "/cart";
					});
					const sameCheckbox = document.getElementById("sameAsCustomer");
					sameCheckbox.addEventListener("change", function () {
						if (this.checked) {
							document.getElementById("recipientName").value =
								document.getElementById("customerName").value;
							document.getElementById("recipientPhone").value =
								document.getElementById("customerPhone").value;
						} else {
							document.getElementById("recipientName").value = "";
							document.getElementById("recipientPhone").value = "";
						}
					});
				});
			</script>
		</div>
</body>

</html>