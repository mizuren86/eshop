<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/base}">

<head>
	<meta charset="utf-8" />
	<title>Checkout - Fruitables</title>
	<style>
		.hidden {
			display: none !important;
		}

		.checkout-block {
			border: 1px solid #ccc;
			padding: 1rem;
			margin-bottom: 1rem;
		}

		.shipping-note {
			margin-top: 1rem;
			font-size: 0.9rem;
			color: #555;
		}


		/* 下拉選單移除預設箭頭 */
		.select-wrapper select {
			-webkit-appearance: none;
			-moz-appearance: none;
			appearance: none;
		}

		/* position-relative 供箭頭絕對定位 */
		.select-wrapper {
			position: relative;
			display: inline-block;
			width: 100%;
		}

		/* 利用 ::after 產生一個空白區，保留錯誤訊息的空間 */
		.select-wrapper::after {
			content: "";
			display: block;
			height: 1.2em;
		}

		/* 箭頭位置設定 */
		.select-wrapper .fa-caret-down {
			position: absolute;
			top: 50%;
			right: 1rem;
			transform: translateY(-50%);
			pointer-events: none;
		}

		/* 將錯誤訊息以絕對定位，放在下拉選單下方 */
		.select-wrapper .error-message {
			position: absolute;
			top: calc(100% - 1.2em);
			left: 0;
			width: 100%;
			margin-top: 0.2em;
			font-size: 0.8em;
			color: red;
			pointer-events: none;
		}

		/* 讓 select 右側預留空間給箭頭 */
		.pe-arrow {
			padding-right: 2rem !important;
		}

		/* <select> 被 disabled 時的樣式 */
		select:disabled {
			background-color: #e0e0e0;
			/* 背景顏色 */
			color: #888;
			/* 文字顏色 */
			cursor: not-allowed;
			/* 滑鼠指標顯示禁止符號 */
			opacity: 0.8;
			/* 文字透明度 */
		}

		/* 運費提示區塊設定 */
		#cartShippingFeeAlert {
			width: 300px;
			min-height: 2rem;
		}

		/* placeholder 樣式 */
		#customerPhone::placeholder,
		#recipientPhone::placeholder,
		#shippingAddress::placeholder {
			color: lightgray;
		}

		#customerPhone::-webkit-input-placeholder,
		#recipientPhone::-webkit-input-placeholder {
			color: lightgray;
		}

		#customerPhone:-ms-input-placeholder,
		#recipientPhone:-ms-input-placeholder {
			color: lightgray;
		}

		table tfoot td {
			border: none;
		}

		.shipping-fee-placeholder {
			background-color: #eaf8ff;
			color: #0d6efd;
			padding: 4px 8px;
			border-radius: 4px;
		}

		#selectStoreBtn {
			margin-bottom: 15px;
		}
	</style>
</head>

<body>
	<div layout:fragment="content">
		<!-- Header -->
		<div class="container-fluid page-header py-5">
			<h1 class="text-center text-white display-6">Checkout</h1>
			<ol class="breadcrumb justify-content-center mb-0">
				<li class="breadcrumb-item"><a th:href="@{/index}">Home</a></li>
				<li class="breadcrumb-item"><a th:href="@{/cart}">Cart</a></li>
				<li class="breadcrumb-item active text-white">Checkout</li>
			</ol>
		</div>

		<input type="hidden" id="couponCodeHidden" th:value="${couponCode}" />

		<!-- Checkout Page -->
		<div class="container py-5" id="checkoutPage">

			<!-- 購物車清單 -->
			<section class="cart-table-section card p-4 mb-4">
				<h4 class="mb-3">購物車</h4>
				<div class="table-responsive">
					<table class="table">
						<thead>
							<tr>
								<th class="text-center"></th>
								<th class="text-center">品名</th>
								<th class="text-center">價格</th>
								<th class="text-center">數量</th>
								<th class="text-center">小計</th>
							</tr>
						</thead>
						<tbody id="cartItems">
							<!-- 由 fetchCartData() 動態生成 -->
						</tbody>
						<tfoot>
							<tr>
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>小計：</strong></td>
								<td id="subtotalAmount" class="text-center align-middle" style="width:200px;">
									<strong th:text="${totalAmount}">$0</strong>
								</td>
							</tr>
							<tr id="cartShippingRow">
								<td colspan="3"></td>
								<td class="text-end align-middle">
									<strong>運費：</strong>
								</td>
								<td id="cartShippingFee" class="text-center align-middle" style="width:200px;">
									<div id="cartShippingFeeAlert" class="alert alert-info mb-0" role="alert">
										將於確認送貨地址後顯示運費
									</div>
								</td>
							</tr>
							<!-- 優惠券折扣列，預設隱藏，由 JS 控制顯示 -->
							<tr id="couponDiscountRow" style="display: none;">
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>優惠券：</strong></td>
								<td id="couponDiscount" class="text-center align-middle" style="width:200px;">
									<strong>-$0</strong>
								</td>
							</tr>
							<tr>
								<td colspan="3"></td>
								<td class="text-end align-middle"><strong>合計：</strong></td>
								<td id="grandTotal" class="text-center align-middle" style="width:200px;">
									<strong>$0</strong>
								</td>
							</tr>
						</tfoot>
					</table>
				</div>
			</section>

			<form id="orderForm" action="/api/checkout/submitOrder" method="post">
				<input type="hidden" name="shippingMethod" th:value="${shippingMethod}" />
				<div th:switch="${shippingMethod}">
					<!-- 1) 7-11 取貨付款 (付現取貨) -->
					<div th:case="'711-cod'" class="branch" data-shipping="711-cod">
						<!--	<div th:switch="${paymentMethod}">     -->
						<!--		<div th:case="'711-cod-only'">     -->
						<div class="row">
							<!-- 左欄：顧客資料與訂單備註 -->
							<div class="col-md-6">
								<div class="card p-3 mb-4">
									<h4 class="mb-3">顧客資料</h4>
									<div class="mb-3">
										<label for="customerName" class="form-label">顧客姓名</label>
										<input type="text" class="form-control required-field" id="customerName"
											name="customerName" data-required="true" placeholder=""
											th:value="${users.username}" />
									</div>
									<div class="mb-3">
										<label for="customerEmail" class="form-label">電子信箱</label>
										<input type="email" class="form-control required-field" id="customerEmail"
											name="customerEmail" data-required="true" placeholder=""
											th:value="${users.email}" />
										<div class="form-text mt-2">
											請填入訂單通知Email (訂單資訊將以此E-mail通知您)
										</div>
									</div>
									<div class="mb-3">
										<label for="customerPhone" class="form-label">電話號碼</label>
										<input type="text" class="form-control required-field" id="customerPhone"
											name="customerPhone" data-required="true" placeholder="0912 345 678"
											th:value="${users.phone}" />
									</div>
								</div>
								<div class="card p-3">
									<h4 class="mb-3">訂單備註</h4>
									<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
										placeholder="有什麼想告訴賣家嗎"></textarea>
								</div>
							</div>
							<!-- 右欄：送貨資料與付款資料 -->
							<div class="col-md-6">
								<div class="card p-3 mb-4">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h4 class="mb-0">送貨資料</h4>
										<p class="shippingCardFeeText mb-0">$60</p>
									</div>
									<p class="mb-1">
										已選擇的送貨方式: 7-11 取貨付款（寄出日系統會發電子郵件通知，
										一般寄出日+2日會抵達門市）<br />
									</p>
									<div class="mb-3 mt-2">
										<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
										<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
									</div>
									<div class="mb-3 mt-3">
										<label for="recipientName" class="form-label">收件人姓名</label>
										<input type="text" class="form-control required-field" id="recipientName"
											name="recipientName" data-required="true" placeholder="" />
										<div class="form-text mt-2">
											請填入收件人真實姓名，以確保順利收件
										</div>
									</div>
									<div class="mb-3">
										<label for="recipientPhone" class="form-label">收件人電話號碼</label>
										<input type="text" class="form-control required-field" id="recipientPhone"
											name="recipientPhone" data-required="true" placeholder="0912 345 678" />
									</div>
									<hr>
									<div style="display: flex; align-items: center; justify-content: left;">
										<img src="img/711logo.png"
											style="max-width: 35px; margin-right: 10px; margin-bottom: 1rem;"
											alt="711 logo">
										<span style="margin-bottom: 15px;">選擇門市</span>
									</div>
									<button id="selectStoreBtn" type="button" class="btn btn-outline-secondary">
										搜尋門市
									</button>
									<div id="selectedStore">
										<!-- 這裡將由 JavaScript 填入門市資訊 -->
									</div>
									<input type="hidden" id="temporaryStoreId" name="temporaryStoreId" value="" />
								</div>
								<div class="card p-3">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h4 class="mb-0">付款資料</h4>
										<p class="mb-0" id="paymentGrandTotal">合計: $0</p>
									</div>
									<p class="m-0">
										已選擇的付款方式: 7-11 取貨付款（包裹抵達指定門市後，付現取貨）
									</p>
								</div>
							</div>
							<!--			</div>      -->
							<!--		</div>          -->
						</div>
					</div>
					<!-- 2) 7-11 取貨不付款 -->
					<div th:case="'711-no-cod'" class="branch" data-shipping="711-no-cod">
						<div th:switch="${paymentMethod}">
							<!-- 2-1) 7-11 取貨不付款 + LINE PAY -->
							<div th:case="'linepay'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">$60</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 7-11 取貨不付款（寄出日系統會發電子郵件通知，
												一般寄出日+2日會抵達門市）<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr>
											<div style="display: flex; align-items: center; justify-content: left;">
												<img src="img/711logo.png"
													style="max-width: 35px; margin-right: 10px; margin-bottom: 1rem;"
													alt="711 logo">
												<span style="margin-bottom: 15px;">選擇門市</span>
											</div>
											<button id="selectStoreBtn" type="button" class="btn btn-outline-secondary">
												搜尋門市
											</button>
											<div id="selectedStore">
												<!-- 這裡將由 JavaScript 填入門市資訊 -->
											</div>
											<input type="hidden" id="temporaryStoreId" name="temporaryStoreId"
												value="" />
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<!-- 固定顯示 LINE Pay -->
											<p class="m-0">已選擇的付款方式: LINE Pay</p>
										</div>
									</div>
								</div>
							</div>
							<!-- 2-2) 7-11 取貨不付款 + 信用卡 -->
							<div th:case="'credit'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">$60</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 7-11 取貨不付款（寄出日系統會發電子郵件通知，
												一般寄出日+2日會抵達門市）<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr>
											<div style="display: flex; align-items: center; justify-content: left;">
												<img src="img/711logo.png"
													style="max-width: 35px; margin-right: 10px; margin-bottom: 1rem;"
													alt="711 logo">
												<span style="margin-bottom: 15px;">選擇門市</span>
											</div>
											<button id="selectStoreBtn" type="button" class="btn btn-outline-secondary">
												搜尋門市
											</button>
											<div id="selectedStore">
												<!-- 這裡將由 JavaScript 填入門市資訊 -->
											</div>
											<input type="hidden" id="temporaryStoreId" name="temporaryStoreId"
												value="" />
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<!-- 固定顯示信用卡 -->
											<p class="m-0">已選擇的付款方式: 信用卡</p>
										</div>
									</div>
								</div>
							</div>

						</div>
					</div>
					<!-- 3) 新竹貨運 -->
					<div th:case="'hct'" class="branch" data-shipping="hct">
						<div th:switch="${paymentMethod}">
							<!-- 3-1) 新竹貨運 + LINE PAY -->
							<div th:case="'linepay'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 新竹貨運<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr />
											<div class="mb-3 mt-3">
												<label class="form-label">地址</label>
												<div class="dropdown-container"
													style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
													<!-- 城市/縣下拉選單 -->
													<div class="form-group select-wrapper city">
														<select id="city" class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成城市/縣選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
													<!-- 地區下拉選單 -->
													<div class="form-group select-wrapper district">
														<select id="district"
															class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成地區選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
												</div>
												<input type="text" class="form-control required-field"
													id="shippingAddress" name="shippingAddress" data-required="true"
													placeholder="地址" />
											</div>
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<p class="m-0">已選擇的付款方式: LINE PAY</p>
										</div>
									</div>
								</div>
							</div>
							<!-- 3-2) 新竹貨運 + 信用卡 -->
							<div th:case="'credit'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 新竹貨運<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr />
											<div class="mb-3 mt-3">
												<label class="form-label">地址</label>
												<div class="dropdown-container"
													style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
													<!-- 城市/縣下拉選單 -->
													<div class="form-group select-wrapper city">
														<select id="city" class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成城市/縣選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
													<!-- 地區下拉選單 -->
													<div class="form-group select-wrapper district">
														<select id="district"
															class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成地區選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
												</div>
												<input type="text" class="form-control required-field"
													id="shippingAddress" name="shippingAddress" data-required="true"
													placeholder="地址" />
											</div>
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<p class="m-0">已選擇的付款方式: 信用卡</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- 4) 外島郵寄 -->
					<div th:case="'outer-island'" class="branch" data-shipping="outer-island">
						<div th:switch="${paymentMethod}">
							<!-- 外島郵寄 + LINE PAY -->
							<div th:case="'linepay'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 外島郵寄<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr />
											<div class="mb-3 mt-3">
												<label class="form-label">地址</label>
												<div class="dropdown-container"
													style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
													<!-- 城市/縣下拉選單 -->
													<div class="form-group select-wrapper city">
														<select id="city" class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成城市/縣選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
													<!-- 地區下拉選單 -->
													<div class="form-group select-wrapper district">
														<select id="district"
															class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成地區選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
												</div>
												<input type="text" class="form-control required-field"
													id="shippingAddress" name="shippingAddress" data-required="true"
													placeholder="地址" />
											</div>
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<p class="m-0">已選擇的付款方式: LINE PAY</p>
										</div>
									</div>
								</div>
							</div>
							<!-- 外島郵寄 + 信用卡 -->
							<div th:case="'credit'">
								<div class="row">
									<!-- 左欄：顧客資料與訂單備註 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<h4 class="mb-3">顧客資料</h4>
											<div class="mb-3">
												<label for="customerName" class="form-label">顧客姓名</label>
												<input type="text" class="form-control required-field" id="customerName"
													name="customerName" data-required="true" placeholder=""
													th:value="${users.username}" />
											</div>
											<div class="mb-3">
												<label for="customerEmail" class="form-label">電子信箱</label>
												<input type="email" class="form-control required-field"
													id="customerEmail" name="customerEmail" data-required="true"
													placeholder="" th:value="${users.email}" />
												<div class="form-text mt-2">
													請填入訂單通知Email (訂單資訊將以此E-mail通知您)
												</div>
											</div>
											<div class="mb-3">
												<label for="customerPhone" class="form-label">電話號碼</label>
												<input type="text" class="form-control required-field"
													id="customerPhone" name="customerPhone" data-required="true"
													placeholder="0912 345 678" th:value="${users.phone}" />
											</div>
										</div>
										<div class="card p-3">
											<h4 class="mb-3">訂單備註</h4>
											<textarea id="orderRemark" name="orderRemark" class="form-control" rows="3"
												placeholder="有什麼想告訴賣家嗎"></textarea>
										</div>
									</div>
									<!-- 右欄：送貨資料與付款資料 -->
									<div class="col-md-6">
										<div class="card p-3 mb-4">
											<!-- 新增「送貨地址」欄位 -->
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">送貨資料</h4>
												<p class="shippingCardFeeText mb-0">將於確認送貨地址後顯示運費</p>
											</div>
											<p class="mb-1">
												已選擇的送貨方式: 外島郵寄<br />
											</p>
											<div class="mb-3 mt-2">
												<input type="checkbox" id="sameAsCustomer" name="sameAsCustomer" />
												<label for="sameAsCustomer">收件人資料與顧客資料相同</label>
											</div>
											<div class="mb-3 mt-3">
												<label for="recipientName" class="form-label">收件人姓名</label>
												<input type="text" class="form-control required-field"
													id="recipientName" name="recipientName" data-required="true"
													placeholder="" />
												<div class="form-text mt-2">
													請填入收件人真實姓名，以確保順利收件
												</div>
											</div>
											<div class="mb-3">
												<label for="recipientPhone" class="form-label">收件人電話號碼</label>
												<input type="text" class="form-control required-field"
													id="recipientPhone" name="recipientPhone" data-required="true"
													placeholder="0912 345 678" />
											</div>
											<hr />
											<div class="mb-3 mt-3">
												<label class="form-label">地址</label>
												<div class="dropdown-container"
													style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem;">
													<!-- 城市/縣下拉選單 -->
													<div class="form-group select-wrapper city">
														<select id="city" class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成城市/縣選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
													<!-- 地區下拉選單 -->
													<div class="form-group select-wrapper district">
														<select id="district"
															class="form-control pe-arrow required-field"
															data-required="true">
															<!-- 動態生成地區選項 -->
														</select>
														<i class="fa fa-caret-down position-absolute"
															style="top: 50%; right: 1rem; transform: translateY(-100%);"></i>
													</div>
												</div>
												<input type="text" class="form-control required-field"
													id="shippingAddress" name="shippingAddress" data-required="true"
													placeholder="地址" />
											</div>
										</div>
										<div class="card p-3">
											<div class="d-flex justify-content-between align-items-center mb-3">
												<h4 class="mb-0">付款資料</h4>
												<p class="mb-0">合計: <span id="paymentGrandTotal">$0</span></p>
											</div>
											<p class="m-0">已選擇的付款方式: 信用卡</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 下方按鈕 -->
				<div style="display: flex; justify-content: space-between" class="mt-4">
					<button id="backToCart" type="button"
						class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase">
						返回購物車
					</button>
					<button id="submitOrder" type="submit"
						class="btn border-secondary rounded-pill px-4 py-3 text-primary text-uppercase">
						提交訂單
					</button>
					<!-- 訂單建立後，將 orderId 傳到結帳頁面 -->
					<input type="hidden" id="orderId" name="orderId" th:value="${order != null ? order.orderId : ''}" />
				</div>

			</form>
			<!-- Checkout Page End -->

			<script th:inline="javascript">
				/*<![CDATA[*/
				// 全域變數：保存購物車小計
				let currentSubtotal = 0;
				// 優惠券折扣（假設從 Session 拿到，若無則為 0）
				var couponDiscountOverall = /*[[${couponDiscount != null ? couponDiscount : 0}]]*/ 0;
				// 假設 shippingMethod 由後端傳入，若無則預設為 "711-cod"
				var shippingMethod = /*[[${shippingMethod}]]*/ "711-cod";

				// 取得現在結帳分支
				function getActiveBranch() {
					const orderForm = document.getElementById("orderForm");
					let activeBranch = null;
					const branches = orderForm.querySelectorAll(".branch");
					branches.forEach(branch => {
						if (branch.dataset.shipping === shippingMethod) {
							activeBranch = branch;
						}
					});
					return activeBranch || orderForm;
				}

				// 更新訂單摘要：呼叫後端 API /api/orderSummary 並更新畫面
				function updateOrderSummary() {
					// 取得目前 active branch
					const activeBranch = getActiveBranch();

					// 預設值
					let selectedCity = "";
					let selectedDistrict = "";

					// 嘗試取得下拉選單元素，如果存在就取值
					const citySelectEl = activeBranch.querySelector(".city select");
					if (citySelectEl) {
						selectedCity = citySelectEl.value;
					}
					const districtSelectEl = activeBranch.querySelector(".district select");
					if (districtSelectEl) {
						selectedDistrict = districtSelectEl.value;
					}

					let couponCode = "";
					const couponCodeHidden = document.getElementById("couponCodeHidden");
					if (couponCodeHidden && couponCodeHidden.value.trim() !== "") {
						couponCode = couponCodeHidden.value.trim();
					} else {
						// 若無隱藏欄位，則從 URL 查詢參數取得
						const params = new URLSearchParams(window.location.search);
						couponCode = params.get("couponCode") || "";
					}

					// 檢查 userId 是否存在
					var userId = /*[[${user.userId}]]*/ 0;
					if (!userId || userId === "null") {
						console.error("UserId not provided.");
						return;
					}

					// 呼叫後端 API 取得訂單摘要
					fetch("/api/orderSummary?userId=" + userId
						+ "&shippingMethod=" + encodeURIComponent(shippingMethod)
						+ "&selectedCity=" + encodeURIComponent(selectedCity)
						+ "&selectedDistrict=" + encodeURIComponent(selectedDistrict)
						+ "&couponCode=" + encodeURIComponent(couponCode))
						.then(response => response.json())
						.then(data => {
							// 更新小計
							document.getElementById("subtotalAmount").innerText = "$" + data.subtotal;

							// 若 shippingMethod 為 "hct" 或 "outer-island" 且尚未選擇城市，
							// 則顯示提示文字；否則顯示從後端取得的運費金額
							if ((shippingMethod === "hct" || shippingMethod === "outer-island") && (selectedCity === "" || selectedDistrict === "")) {
								document.getElementById("cartShippingFeeAlert").innerText = "將於確認送貨地址後顯示運費";
								document.querySelectorAll(".shippingCardFeeText").forEach(el => {
									el.textContent = "將於確認送貨地址後顯示運費";
								});
							} else {
								document.getElementById("cartShippingFeeAlert").innerText = "NT$" + data.shippingFee;
								document.querySelectorAll(".shippingCardFeeText").forEach(el => {
									el.textContent = "運費 NT$" + data.shippingFee;
								});
							}

							// 更新優惠券折扣顯示
							if (data.couponDiscount > 0) {
								document.getElementById("couponDiscountRow").style.display = "table-row";
								document.getElementById("couponDiscount").innerText = "-$" + data.couponDiscount;
							} else {
								document.getElementById("couponDiscountRow").style.display = "none";
							}

							// 更新合計
							document.getElementById("grandTotal").innerText = "$" + data.grandTotal;
							document.getElementById("paymentGrandTotal").innerText = "$" + data.grandTotal;
							currentSubtotal = data.subtotal;
						})
						.catch(error => console.error("Error updating order summary:", error));
				}

				// 載入購物車資料（與 cart.html 類似，這邊顯示訂單摘要部分保持不變）
				async function fetchCartData() {
					try {
						const response = await fetch("/api/cart");
						if (!response.ok) throw new Error("Network response was not ok");
						const {cartItems, totalAmount} = await response.json();

						if (cartItems.length === 0) {
							const cartSection = document.getElementById("cartSection");
							if (cartSection) {
								cartSection.classList.add("d-none");
							}
							return;
						}

						currentSubtotal = 0;
						const cartItemsContainer = document.getElementById("cartItems");
						cartItemsContainer.innerHTML = "";

						cartItems.forEach((item) => {
							currentSubtotal += item.subTotal;
							const row = document.createElement("tr");
							row.innerHTML = `
				                <td class="text-center align-middle">
				                  <img src="${item.product.imageUrl}" alt="" class="img-fluid rounded-circle" style="width:80px; height:80px;">
				                </td>
				                <td class="text-center align-middle">${item.product.productName}</td>
				                <td class="text-center align-middle">$${item.price}</td>
				                <td class="text-center align-middle">
				                  <span id="quantity-${item.cartItemId}" class="text-center">${item.quantity}</span>
				                </td>
				                <td class="text-center align-middle">$${item.subTotal}</td>
				              `;
							cartItemsContainer.appendChild(row);
						});
						document.getElementById("subtotalAmount").textContent = "$" + currentSubtotal;
						updateOrderSummary();
					} catch (error) {
						console.error("Error fetching cart data:", error);
					}
				}

				// 頁面加載後載入購物車資料
				document.addEventListener("DOMContentLoaded", fetchCartData);

				// 地址下拉選單與運費更新邏輯
				document.addEventListener("DOMContentLoaded", function () {
					// 取得目前 active branch
					const activeBranch = getActiveBranch();
					// 嘗試取得 .city select 元素
					const citySelect = activeBranch.querySelector(".city select");
					// 如果找不到，代表這個分支不需要選擇城市，直接跳過更新
					if (!citySelect) {
						updateOrderSummary();
						return;
					}
					// 嘗試取得 .district select 元素
					const districtSelect = activeBranch.querySelector(".district select");
					// 如果找不到，則同樣跳過
					if (!districtSelect) {
						updateOrderSummary();
						return;
					}

					// 定義城市與地區對應資料
					var hctCityDistricts = {
						"台北市": ["100中正區", "103大同區", "104中山區", "105松山區", "106大安區",
							"108萬華區", "110信義區", "111士林區", "112北投區", "114內湖區",
							"115南港區", "116文山區"],
						"基隆市": ["200仁愛區", "201信義區", "202中正區", "203中山區", "204安樂區",
							"205暖暖區", "206七堵區"],
						"新北市": ["207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"223石碇區", "224瑞芳區", "226平溪區", "227雙溪區", "228貢寮區",
							"231新店區", "232坪林區", "233烏來區", "234永和區", "235中和區",
							"236土城區", "237三峽區", "238樹林區", "239鶯歌區", "241三重區",
							"242新莊區", "243泰山區", "244林口區", "247蘆洲區", "248五股區",
							"249八里區", "251淡水區", "252三芝區", "253石門區"],
						"宜蘭縣": ["207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"207萬里區", "208金山區", "220板橋區", "221汐止區", "222深坑區",
							"207萬里區", "208金山區"],
						"新竹縣": ["300北區", "300東區", "300香山區"],
						"新竹市": ["302竹北區", "303湖口鄉", "304新豐鄉", "305新埔鎮", "306關西鎮",
							"307芎林鄉", "308寶山鄉", "310竹東鎮", "311五峰鄉", "312橫山鄉",
							"313尖石鄉", "314北埔鄉", "315峨眉鄉"],
						"桃園市": ["320中壢區", "324平鎮區", "325龍潭區", "326楊梅區", "327新屋區",
							"328觀音區", "330桃園區", "333龜山區", "334八德區", "335大溪區",
							"336復興區", "337大園區", "338蘆竹區"],
						"苗栗縣": ["350竹南鎮", "351頭份市", "352三灣鄉", "353南庄鄉", "354獅潭鄉",
							"356後龍鎮", "357通霄鎮", "358苑裡鎮", "360苗栗市", "361造橋鄉",
							"362頭屋鄉", "363公館鄉", "364大湖鄉", "365泰安鄉", "366銅鑼鄉",
							"367三義鄉", "368西湖鄉", "369卓蘭鎮"],
						"台中市": ["400中區", "401東區", "402南區", "403西區", "404北區",
							"406北屯區", "407西屯區", "408南屯區", "411太平區", "412大里區",
							"413霧峰區", "414烏日區", "420豐原區", "421后里區", "422石岡區",
							"423東勢區", "424和平區", "426新社區", "427潭子區", "428大雅區",
							"429神岡區", "432大肚區", "433沙鹿區", "434龍井區", "435梧棲區",
							"436清水區", "437大甲區", "438外埔區", "439大安區"],
						"彰化縣": ["500彰化市", "502芬園鄉", "503花壇鄉", "504秀水鄉", "505鹿港鎮",
							"506福興鄉", "507線西鄉", "508和美鎮", "509伸港鄉", "510員林市",
							"511社頭鄉", "512永靖鄉", "513埔心鄉", "514溪湖鎮", "515大村鄉",
							"516埔鹽鄉", "520田中鎮", "521北斗鎮", "522田尾鄉", "523埤頭鄉",
							"524溪州鄉", "525竹塘鄉", "526二林鎮", "527大城鄉", "528芳苑鄉",
							"530二水鄉"],
						"南投縣": ["540南投市", "541中寮鄉", "542草屯鎮", "544國姓鄉", "545埔里鎮",
							"546仁愛鄉", "551名間鄉", "552集集鎮", "553水里鄉", "555魚池鄉",
							"556信義鄉", "557竹山鎮", "558鹿谷鄉"],
						"嘉義市": ["600東區", "600大西區"],
						"嘉義縣": ["602番路鄉", "603梅山鄉", "604竹崎鄉", "605阿里山鄉", "606中埔鄉",
							"607大埔鄉", "608水上鄉", "611鹿草鄉", "612太保市", "613朴子市",
							"614東石鄉", "615六腳鄉", "616新港鄉", "621民雄鄉", "622大林鎮",
							"623溪口鄉", "624義竹鄉", "625布袋鎮"],
						"雲林縣": ["630斗南鎮", "631大埤鄉", "632虎尾鎮", "633土庫鎮", "634褒忠鄉",
							"635東勢鄉", "636臺西鄉", "637崙背鄉", "638麥寮鄉", "640斗六市",
							"643林內鄉", "646古坑鄉", "647莿桐鄉", "648西螺鎮", "649二崙鄉",
							"651北港鎮", "652水林鄉", "653口湖鄉", "654四湖鄉", "655元長鄉"],
						"台南市": ["700中西區", "701東區", "702南區", "704北區", "708安平區",
							"709安南區", "710永康區", "711歸仁區", "712新化區", "713左鎮區",
							"714玉井區", "715楠西區", "716南化區", "717仁德區", "718關廟區",
							"719龍崎區", "720官田區", "721麻豆區", "722佳里區", "723西港區",
							"724七股區", "725將軍區", "726學甲區", "727北門區", "730新營區",
							"731後壁區", "732白河區", "733東山區", "734六甲區", "735下營區",
							"736柳營區", "737鹽水區", "741善化區", "742大內區", "743山上區",
							"744新市區", "745安定區"],
						"高雄市": ["800新興區", "801前金區", "802苓雅區", "803鹽埕區", "804鼓山區",
							"805旗津區", "806前鎮區", "807三民區", "811楠梓區", "812小港區",
							"813左營區", "814仁武區", "815大社區", "820岡山區", "821路竹區",
							"822阿蓮區", "823田寮區", "824燕巢區", "825橋頭區", "826梓官區",
							"827彌陀區", "828永安區", "829湖內區", "830鳳山區", "831大寮區",
							"832林園區", "833鳥松區", "840大樹區", "842旗山區", "843美濃區",
							"844六龜區", "845內門區", "846杉林區", "847甲仙區", "848桃源區",
							"849那瑪夏區", "851茂林區", "852茄萣區"],
						"屏東縣": ["900屏東市", "901三地門鄉", "902霧臺鄉", "903瑪家鄉", "904九如鄉",
							"905里港鄉", "906高樹鄉", "907鹽埔鄉", "908長治鄉", "909麟洛鄉",
							"911竹田鄉", "912內埔鄉", "913萬丹鄉", "920潮州鎮", "921泰武鄉",
							"922來義鄉", "923萬巒鄉", "924崁頂鄉", "925新埤鄉", "926南州鄉",
							"927林邊鄉", "928東港鎮", "931佳冬鄉", "932新園鄉", "940枋寮鄉",
							"941枋山鄉", "942春日鄉", "943獅子鄉", "944車城鄉", "945牡丹鄉",
							"946恆春鎮", "947滿州鄉"],
						"臺東縣": ["950臺東市", "953延平鄉", "954卑南鄉", "955鹿野鄉", "956關山鎮",
							"957海端鄉", "958池上鄉", "959東河鄉", "961成功鎮", "962長濱鄉",
							"963太麻里鄉", "964金峰鄉", "965大武鄉", "966達仁鄉"],
						"花蓮縣": ["970花蓮市", "971新城鄉", "972秀林鄉", "973吉安鄉", "974壽豐鄉",
							"975鳳林鎮", "976光復鄉", "977豐濱鄉", "978瑞穗鄉", "979萬榮鄉",
							"981玉里鎮", "982卓溪鄉", "983富里鄉"]
					};

					var outerIslandCityDistricts = {
						"屏東縣": ["929琉球鄉"],
						"台東縣": ["951綠島鄉", "952蘭嶼鄉"],
						"澎湖縣": ["880馬公市", "881西嶼鄉", "882望安鄉", "883七美鄉", "884白沙鄉", "885湖西鄉"],
						"金門縣": ["890金沙鎮", "891金湖鄉", "892金寧鄉", "893金城鄉", "894烈嶼鄉", "896烏坵鄉"],
						"連江縣": ["209南竿鄉", "210北竿鄉", "211莒光鄉", "212東引鄉"]
					};

					// 根據 shippingMethod 選擇使用的地址資料
					var addressOptions = (shippingMethod === "outer-island") ? outerIslandCityDistricts : hctCityDistricts;

					// 初始化城市下拉選單提示
					citySelect.innerHTML = "";
					var defaultCityOption = document.createElement("option");
					defaultCityOption.value = "";
					defaultCityOption.textContent = "城市/縣";
					defaultCityOption.disabled = true;
					defaultCityOption.selected = true;
					citySelect.appendChild(defaultCityOption);

					// 初始化區下拉選單提示
					districtSelect.innerHTML = "";
					var defaultDistOption = document.createElement("option");
					defaultDistOption.value = "";
					defaultDistOption.textContent = "地區";
					defaultDistOption.disabled = true;
					defaultDistOption.selected = true;
					districtSelect.appendChild(defaultDistOption);
					districtSelect.disabled = true;

					// 填入城市選項
					for (var city in addressOptions) {
						var option = document.createElement("option");
						option.value = city;
						option.textContent = city;
						citySelect.appendChild(option);
					}

					// 當城市選項改變時，更新區選單及重置運費提示
					function updateDistrictOptions() {
						// 先取得當前的 activeBranch
						const activeBranch = getActiveBranch();
						// 嘗試取得 .city select 元素
						const citySelect = activeBranch.querySelector(".city select");
						// 如果找不到，代表這個分支不需要選擇城市，直接跳過更新
						if (!citySelect) {
							updateOrderSummary();
							return;
						}
						// 嘗試取得 .district select 元素
						const districtSelect = activeBranch.querySelector(".district select");
						// 如果找不到，則同樣跳過
						if (!districtSelect) {
							updateOrderSummary();
							return;
						}

						if (shippingMethod === "711-cod" || shippingMethod === "711-no-cod") {
							document.querySelectorAll(".shippingCardFeeText").forEach(el => {
								el.textContent = "運費 NT$" + 60;
							});
							updateOrderSummary();
							return;
						}

						var selectedCity = citySelect.value;
						var districts = addressOptions[selectedCity] || [];
						if (!selectedCity) {
							districtSelect.innerHTML = "";
							var defaultDist = document.createElement("option");
							defaultDist.value = "";
							defaultDist.textContent = "地區";
							defaultDist.disabled = true;
							defaultDist.selected = true;
							districtSelect.appendChild(defaultDist);
							districtSelect.disabled = true;
							return;
						}
						districtSelect.innerHTML = "";
						districtSelect.disabled = false;
						var defaultDistOption = document.createElement("option");
						defaultDistOption.value = "";
						defaultDistOption.textContent = "地區";
						defaultDistOption.disabled = true;
						defaultDistOption.selected = true;
						districtSelect.appendChild(defaultDistOption);

						districts.forEach(function (dist) {
							var option = document.createElement("option");
							option.value = dist;
							option.textContent = dist;
							districtSelect.appendChild(option);
						});

						updateOrderSummary();
					}
					citySelect.addEventListener("change", updateDistrictOptions);
					districtSelect.addEventListener("change", updateOrderSummary);
					updateDistrictOptions();
				});


				// 重新載入購物車資料
				document.addEventListener("DOMContentLoaded", fetchCartData);
				
				/////////////////////////
//				async function fetchSelectedStore() {
//				        try {
//				            const response = await fetch("/api/selectedStore", {
//				                headers: {
//				                    'ngrok-skip-browser-warning': 'any_value' // 若使用 ngrok，加入這個標頭
//				                }
//				            });
//				            if (response.ok) {
//				                const store = await response.json();
//				                if (store) {
//				                    document.getElementById("selectedStore").innerHTML = `
//				                        <h5>已選擇門市</h5>
//				                        <p>門市編號：${store.storeID}</p>
//				                        <p>門市名稱：${store.storeName}</p>
//				                        <p>地址：${store.storeAddress}</p>
//				                        <p>電話：${store.storePhone}</p>
//				                    `;
//				                }
//				            } else {
//				                // 如果 API 回傳 404，也可以清空或顯示提示訊息
//				                document.getElementById("selectedStore").innerHTML = "<p>尚未選擇門市</p>";
//				            }
//				        } catch (error) {
//				            console.error("Error fetching selected store:", error);
//				        }
//				    }
				    // 每隔 3 秒查詢一次
				//    setInterval(fetchSelectedStore, 3000);
				/////////////////////////

				// 用來移除錯誤訊息的函式
				function removeError(inputElement) {
					const errorElem = inputElement.parentElement.querySelector(".error-message");
					if (errorElem) {
						errorElem.remove();
					}
				}


				// 返回購物車、收件人資料複製
				document.addEventListener("DOMContentLoaded", function () {
					document.getElementById("backToCart").addEventListener("click", function () {
						window.location.href = "/cart";
					});
					const sameCheckbox = document.getElementById("sameAsCustomer");
					sameCheckbox.addEventListener("change", function () {
						console.log("同顧客資料複製勾選狀態:", this.checked);
						const recipientName = document.getElementById("recipientName");
						const recipientPhone = document.getElementById("recipientPhone");
						const customerName = document.getElementById("customerName");
						const customerPhone = document.getElementById("customerPhone");
						if (this.checked) {
							// 複製資料
							recipientName.value = document.getElementById("customerName").value;
							recipientPhone.value = document.getElementById("customerPhone").value;
							// 清除對應的錯誤訊息
							removeError(recipientName);
							removeError(recipientPhone);
							// 如果有自動驗證，也可觸發 input 事件
							recipientName.dispatchEvent(new Event("input", {bubbles: true}));
							recipientPhone.dispatchEvent(new Event("input", {bubbles: true}));
						} else {
							// 清空欄位
							recipientName.value = "";
							recipientPhone.value = "";
						}
					});
				});

				// 綠界地圖 API
				const selectStoreBtn = document.getElementById("selectStoreBtn");
				if (selectStoreBtn) {
					selectStoreBtn.addEventListener("click", function () {
						window.location.href = "/ecpay/expressMap";
					});
				}

				// 解析 URL 查詢參數並取得 temporaryStoreId（用於門市選擇）
				function getQueryParams() {
					const params = {};
					const queryString = window.location.search.substring(1);
					queryString.split("&").forEach(function (param) {
						const pair = param.split("=");
						params[pair[0]] = decodeURIComponent(pair[1]);
					});
					return params;
				}

				// 當頁面載入時，從 URL 取得 temporaryStoreId 並呼叫 API
				document.addEventListener("DOMContentLoaded", function () {
					const params = getQueryParams();

					// 檢查隱藏欄位 temporaryStoreId 是否存在
					const tempStoreInput = document.getElementById("temporaryStoreId");
					if (tempStoreInput && params.temporaryStoreId) {
						tempStoreInput.value = params.temporaryStoreId;
						fetchSelectedStore(params.temporaryStoreId);
					}

					// 檢查 selectedStore 元素是否存在，若存在且 temporaryStoreId 沒有，則顯示預設訊息
					const selectedStoreEl = document.getElementById("selectedStore");
					if (selectedStoreEl) {
						if (!params.temporaryStoreId) {
							selectedStoreEl.innerHTML = "<p>尚未選擇門市</p>";
						}
					}
				});

				// 根據 temporaryStoreId 從 API 取得門市資料
				async function fetchSelectedStore(storeId) {
					try {
						const response = await fetch(`/api/temporaryStore/${storeId}`);
						if (response.ok) {
							const selectedStore = await response.json();
							console.log("API 回傳的 SelectedStore:", selectedStore);
							if (selectedStore) {
								document.getElementById("selectedStore").innerHTML = `
									<h5>已選擇門市</h5>
									<p>門市店號：${selectedStore.cvsstoreId}</p>
									<p>門市名稱：${selectedStore.cvsstoreName}</p>
									<p>門市地址：${selectedStore.cvsaddress}</p>
									`;
							}
						} else {
							document.getElementById("selectedStore").innerHTML = "<p>尚未選擇門市</p>";
						}
					} catch (error) {
						console.error("Error fetching selected store:", error);
					}
				}

				document.addEventListener("DOMContentLoaded", fetchCartData);

				console.log("Checkout page script loaded");

				// 提交訂單前表單驗證
				document.addEventListener("DOMContentLoaded", function () {
					const orderForm = document.getElementById("orderForm");

					// 檢查 shippingMethod 是否正確
					console.log("shippingMethod:", shippingMethod);

					// 用 data‑shipping 屬性找出目前 active 的 branch
					let activeBranch = null;
					const branches = orderForm.querySelectorAll('.branch');
					branches.forEach(branch => {
						if (branch.dataset.shipping === shippingMethod) {
							activeBranch = branch;
						}
					});
					// 若找不到，則預設以整個表單作驗證
					if (!activeBranch) {
						console.warn("找不到 active branch，將以整個 form 驗證");
						activeBranch = orderForm;
					}
					console.log("activeBranch:", activeBranch);

					// 當表單送出時，僅檢查 activeBranch 中的必填欄位
					orderForm.addEventListener("submit", function (e) {
						// 只從 active branch 取得必填欄位
						const requiredFields = activeBranch.querySelectorAll("[data-required='true']");
						let valid = true;

						// 清除所有先前的錯誤訊息
						requiredFields.forEach(field => {
							clearError(field);
						});

						// 檢查每個必填欄位，但只處理可見的欄位
						requiredFields.forEach(field => {
							if (field.value.trim() === "") {
								valid = false;
								showError(field, "此欄位必填");
							}
						});

						if (!valid) {
							e.preventDefault(); // 阻止表單送出
							alert("請填寫所有必填資料");
						}
					});

					// 清除某個輸入框下的錯誤訊息（只移除該欄位相關的錯誤提示）
					function clearError(inputElement) {
						const parent = inputElement.parentElement;
						const errorElem = parent.querySelector(".error-message");
						if (errorElem) {
							errorElem.remove();
						}
					}

					// 在指定輸入框下方加入錯誤訊息
					function showError(inputElement, message) {
						// 若已存在錯誤訊息則不重複新增
						if (inputElement.parentElement.querySelector(".error-message")) return;
						const error = document.createElement("div");
						error.className = "error-message";
						error.style.color = "red";
						error.style.fontSize = "0.9rem";
						error.innerText = message;
						inputElement.parentElement.appendChild(error);
					}

					// 當使用者 focus 某個必填欄位時，清除其錯誤訊息
					const allRequired = orderForm.querySelectorAll("[data-required='true']");
					allRequired.forEach(field => {
						field.addEventListener("focus", function () {
							clearError(field);
						});
					});
				});


				// 城市和區域存入 session
				document.addEventListener("DOMContentLoaded", function () {
					// 假設 updateDistrictOptions() 已定義且可以使用

					// 取得城市和區域的下拉選單元素
					const citySelect = document.getElementById("city");
					const districtSelect = document.getElementById("district");

					// 定義將選擇的城市與區域存入 session 的函式
					function saveShippingAddressToSession() {
						const selectedCity = citySelect.value;
						const selectedDistrict = districtSelect.value;

						// 利用 fetch API 發送 POST 請求
						fetch('/api/checkout/session/setShippingAddress', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/x-www-form-urlencoded'
							},
							body: new URLSearchParams({
								selectedCity: selectedCity,
								selectedDistrict: selectedDistrict
							})
						})
							.then(response => response.json())
							.then(data => console.log("Session data saved:", data))
							.catch(error => console.error("Error saving session data:", error));
					}

					// 當城市選擇改變時，同時更新區域選單並儲存到 session
					citySelect.addEventListener("change", function () {
						updateDistrictOptions();  // 這裡假設你已有 updateDistrictOptions() 方法
						saveShippingAddressToSession();
					});

					// 當區域選擇改變時也儲存
					districtSelect.addEventListener("change", saveShippingAddressToSession);
				});
				/*]]>*/
			</script>
		</div>
</body>

</html>